name: CI-CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  COVERAGE_THRESHOLD: 75

jobs:
  build:
    name: Build (frontend)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mini-ola-frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mini-ola-frontend/package-lock.json

      - name: Install frontend deps
        run: npm ci

      - name: Lint frontend (if configured)
        run: |
          if npm run | grep -q "lint"; then
            npm run lint || echo "Frontend lint issues (non-fatal in build)"
          else
            echo "No frontend lint script"
          fi

      - name: Build frontend
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: mini-ola-frontend/dist

  test:
    name: Test (backend)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mini-ola-backend
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mini-ola-backend/package-lock.json

      - name: Install backend deps
        run: npm ci

      - name: Lint backend (if configured)
        run: |
          if npm run | grep -q "lint"; then
            npm run lint || echo "Backend lint issues (non-fatal in tests)"
          else
            echo "No backend lint script"
          fi

      - name: Run Unit+Integration Tests with Coverage
        env:
          NODE_ENV: test
        run: npm test -- --coverage --coverageDirectory=coverage

      - name: Upload backend coverage
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: mini-ola-backend/coverage

  coverage:
    name: Coverage enforcement
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend-coverage

      - name: Enforce coverage threshold
        run: |
          node -e "
          const fs = require('fs');
          const p = 'backend-coverage/coverage-summary.json';
          if (!fs.existsSync(p)) { console.error('coverage-summary.json not found'); process.exit(1); }
          const c = JSON.parse(fs.readFileSync(p, 'utf8'));
          const pct = c.total && c.total.lines && c.total.lines.pct;
          console.log('Lines coverage:', pct);
          const threshold = Number(process.env.COVERAGE_THRESHOLD || 75);
          if (typeof pct !== 'number') { console.error('Unable to read coverage percentage'); process.exit(1); }
          if (pct < threshold) { console.error(\`Coverage ${pct}% < threshold ${threshold}%\`); process.exit(1); }
          console.log(\`Coverage OK: ${pct}% >= ${threshold}%\`);
          "

  lint:
    name: Lint (aggregate)
    runs-on: ubuntu-latest
    needs: [build, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mini-ola-backend/package-lock.json

      - name: Lint backend (strict)
        working-directory: mini-ola-backend
        run: |
          if npm run | grep -q "lint"; then
            npm run lint
          else
            echo "No backend lint script"
          fi

      - name: Lint frontend (strict)
        working-directory: mini-ola-frontend
        run: |
          if npm run | grep -q "lint"; then
            npm run lint
          else
            echo "No frontend lint script"
          fi

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: mini-ola-backend/package-lock.json

      - name: Install backend deps (audit)
        working-directory: mini-ola-backend
        run: npm ci

      - name: Run npm audit (backend)
        working-directory: mini-ola-backend
        run: |
          npm audit --audit-level=high || echo "High/severe audit issues found (review output)"

      - name: Install frontend deps (audit)
        working-directory: mini-ola-frontend
        run: npm ci

      - name: Run npm audit (frontend)
        working-directory: mini-ola-frontend
        run: |
          npm audit --audit-level=high || echo "High/severe audit issues found (review output)"

  package:
    name: Package Deployment Artifact
    runs-on: ubuntu-latest
    needs: [coverage, security]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist

      - name: Download backend coverage (optional)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend-coverage

      - name: Create deploy folder
        run: |
          mkdir -p deploy
          cp -r frontend-dist deploy/frontend || true
          cp -r backend-coverage deploy/backend-coverage || true
          tar -czf deploy/backend-src.tar.gz mini-ola-backend || true
          echo "Prepared deploy artifact"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: full-stack-artifact
          path: deploy

  deploy:
    name: Deploy (main only placeholder)
    if: github.ref == 'refs/heads/main'
    needs: package
    runs-on: ubuntu-latest
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: full-stack-artifact
          path: full-stack-artifact

      - name: Placeholder deploy step
        run: |
          echo "Deploying artifact..."
          ls -R full-stack-artifact
