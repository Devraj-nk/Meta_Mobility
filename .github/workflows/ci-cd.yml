name: CI-CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mini-ola-backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install deps (backend)
        run: npm ci
      - name: Lint (skip if no lint script)
        run: |
          if npm run | grep -q "lint"; then
            npm run lint || echo "No backend lint configured"
          else
            echo "No lint script"
          fi
      - name: Run Unit+Integration Tests with Coverage
        env:
          NODE_ENV: test
        run: npm test -- --coverage
      - name: Upload coverage (backend)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: mini-ola-backend/coverage
      - name: Security Audit
        run: npm audit --audit-level=high || echo "Audit issues found"

  frontend:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mini-ola-frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install deps (frontend)
        run: npm ci
      - name: Lint frontend
        run: |
          if npm run | grep -q "lint"; then
            npm run lint || echo "Frontend lint errors"
          else
            echo "No lint script"
          fi
      - name: Build frontend
        run: npm run build
      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: mini-ola-frontend/dist

  aggregate:
    name: Aggregate & Quality Gates
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    steps:
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend-coverage
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist
      - name: Summarize coverage
        run: |
          if [ -f backend-coverage/lcov.info ]; then
            echo "Backend coverage summary:"; grep -A2 SF: backend-coverage/lcov.info | head -n 30 || true
          else
            echo "No backend coverage file found"
          fi
      - name: Prepare deployment artifact
        run: |
          mkdir -p deploy
          cp -r frontend-dist deploy/frontend
          cp -r backend-coverage deploy/backend-coverage || true
          echo "Generated combined artifact"
      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: full-stack-artifact
          path: deploy

  deploy:
    name: Deploy (Main Branch Only)
    if: github.ref == 'refs/heads/main'
    needs: aggregate
    runs-on: ubuntu-latest
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: full-stack-artifact
          path: full-stack-artifact
      - name: Placeholder deploy step
        run: echo "Deploying artifact..." && ls -R full-stack-artifact
